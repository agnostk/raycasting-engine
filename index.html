<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Raycasting Engine</title>
  </head>
  <body
    style="
      margin: 0;
      padding: 0;
      width: 100vw;
      height: 100vh;
      background-color: black;
      display: flex;
      justify-content: center;
      align-items: center;
    "
  >
    <canvas id="gameCanvas"></canvas>
    <script>
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");

      const map = [
        [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
        [1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
        [1, 0, 1, 1, 0, 1, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1],
        [1, 0, 1, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 1],
        [1, 0, 1, 1, 0, 1, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 1, 1, 1, 1, 1],
        [1, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 1, 0, 0, 0, 1],
        [1, 0, 1, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 0, 1, 0, 1],
        [1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 1, 0, 1, 0, 1, 0, 1],
        [1, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 1, 1, 0, 1],
        [1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1],
        [1, 0, 1, 1, 1, 0, 1, 0, 0, 0, 1, 0, 0, 1, 0, 0, 1, 1, 1, 1, 1, 0, 1],
        [1, 0, 1, 0, 1, 0, 1, 0, 0, 0, 1, 1, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 1],
        [1, 0, 1, 0, 1, 0, 1, 1, 1, 0, 0, 1, 0, 0, 1, 0, 1, 0, 0, 0, 1, 0, 1],
        [1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 1, 0, 1],
        [1, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1],
        [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
        [1, 1, 1, 1, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1],
        [1, 0, 0, 0, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1],
        [1, 0, 1, 1, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1],
        [1, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
        [1, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 0, 1],
        [1, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 1],
        [1, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 1],
        [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1],
        [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
      ];

      const SCREEN_WIDTH = 800;
      const SCREEN_HEIGHT = 600;
      canvas.width = SCREEN_WIDTH;
      canvas.height = SCREEN_HEIGHT;

      const mapWidth = map[0].length;
      const mapHeight = map.length;

      const player = {
        x: 10.5,
        y: 4.5,
        speed: 0.04,
        rot: 0,
        rotSpeed: 0.03,
        fov: Math.PI / 3,
      };

      const keyState = {};
      document.addEventListener("keydown", (e) => (keyState[e.key] = true));
      document.addEventListener("keyup", (e) => (keyState[e.key] = false));

      function castRay(angle) {
        const sin = Math.sin(angle);
        const cos = Math.cos(angle);

        for (let i = 0; i < 8; i += 0.01) {
          const x = player.x + cos * i;
          const y = player.y + sin * i;
          const tx = Math.floor(x);
          const ty = Math.floor(y);

          if (tx < 0 || tx >= mapWidth || ty < 0 || ty >= mapHeight) return i;

          if (map[ty][tx] === 1) return i;
        }

        return 20;
      }

      function renderCamera() {
        ctx.fillStyle = "black";
        ctx.fillRect(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT);

        for (let i = 0; i < SCREEN_WIDTH; i++) {
          const rayAngle =
            player.rot - player.fov / 2 + (i / SCREEN_WIDTH) * player.fov;

          const dist = castRay(rayAngle);
          const corrected = dist * Math.cos(rayAngle - player.rot);
          const wallHeight =
            Math.min(SCREEN_HEIGHT, SCREEN_HEIGHT / corrected) * 1.25;

          const shade = 200 - Math.min(200, corrected * 40);
          ctx.fillStyle = `rgb(${shade},${shade},${shade})`;
          ctx.fillRect(i, (SCREEN_HEIGHT - wallHeight) / 2, 1, wallHeight);
        }
      }

      function updatePlayerState() {
        if (keyState["a"]) player.rot -= player.rotSpeed;
        if (keyState["d"]) player.rot += player.rotSpeed;

        const deltaX = Math.cos(player.rot) * player.speed;
        const deltaY = Math.sin(player.rot) * player.speed;

        if (keyState["w"]) {
          const newX = player.x + deltaX;
          const newY = player.y + deltaY;
          if (canPlayerMove(newX, newY)) {
            player.x = newX;
            player.y = newY;
          }
        }

        if (keyState["s"]) {
          const newX = player.x - deltaX;
          const newY = player.y - deltaY;
          if (canPlayerMove(newX, newY)) {
            player.x = newX;
            player.y = newY;
          }
        }
      }

      function canPlayerMove(x, y) {
        const tx = Math.floor(x);
        const ty = Math.floor(y);
        return map[ty] && map[ty][tx] === 0;
      }

      function renderMinimap() {
        const scale = 6;
        ctx.save();
        ctx.translate(10, 10);

        for (let y = 0; y < mapHeight; y++) {
          for (let x = 0; x < mapWidth; x++) {
            ctx.fillStyle = map[y][x] === 1 ? "#777" : "#222";
            ctx.fillRect(x * scale, y * scale, scale, scale);
          }
        }

        ctx.fillStyle = "#ff00ff";
        ctx.beginPath();
        ctx.arc(
          player.x * scale,
          player.y * scale,
          scale / 2.5,
          0,
          Math.PI * 2
        );
        ctx.fill();

        ctx.strokeStyle = "#00ffff";
        ctx.beginPath();
        ctx.moveTo(player.x * scale, player.y * scale);
        ctx.lineTo(
          (player.x + Math.cos(player.rot)) * scale,
          (player.y + Math.sin(player.rot)) * scale
        );
        ctx.stroke();

        ctx.restore();
      }

      function gameLoop() {
        updatePlayerState();
        renderCamera();
        renderMinimap();
        requestAnimationFrame(gameLoop);
      }

      gameLoop();
    </script>
  </body>
</html>
